{"ast":null,"code":"/*\nThis file is part of web3.js.\n\nweb3.js is free software: you can redistribute it and/or modify\nit under the terms of the GNU Lesser General Public License as published by\nthe Free Software Foundation, either version 3 of the License, or\n(at your option) any later version.\n\nweb3.js is distributed in the hope that it will be useful,\nbut WITHOUT ANY WARRANTY; without even the implied warranty of\nMERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\nGNU Lesser General Public License for more details.\n\nYou should have received a copy of the GNU Lesser General Public License\nalong with web3.js.  If not, see <http://www.gnu.org/licenses/>.\n*/\nimport { format, toHex } from 'web3-utils';\nimport { HardforksOrdered, ETH_DATA_FORMAT } from 'web3-types';\nimport { Web3ValidatorError, isNullish, validator } from 'web3-validator';\nimport { InvalidPropertiesForTransactionTypeError } from 'web3-errors';\n// undefined is treated as null for JSON schema validator\nconst transactionType0x0Schema = {\n  type: 'object',\n  properties: {\n    accessList: {\n      type: 'null'\n    },\n    maxFeePerGas: {\n      type: 'null'\n    },\n    maxPriorityFeePerGas: {\n      type: 'null'\n    }\n  }\n};\nconst transactionType0x1Schema = {\n  type: 'object',\n  properties: {\n    maxFeePerGas: {\n      type: 'null'\n    },\n    maxPriorityFeePerGas: {\n      type: 'null'\n    }\n  }\n};\nconst transactionType0x2Schema = {\n  type: 'object',\n  properties: {\n    gasPrice: {\n      type: 'null'\n    }\n  }\n};\nconst validateTxTypeAndHandleErrors = (txSchema, tx, txType) => {\n  try {\n    validator.validateJSONSchema(txSchema, tx);\n  } catch (error) {\n    if (error instanceof Web3ValidatorError)\n      // Erroneously reported error\n      // eslint-disable-next-line @typescript-eslint/no-unsafe-call\n      throw new InvalidPropertiesForTransactionTypeError(error.errors, txType);\n    throw error;\n  }\n};\nexport const defaultTransactionTypeParser = transaction => {\n  var _a, _b;\n  const tx = transaction;\n  if (!isNullish(tx.type)) {\n    let txSchema;\n    switch (tx.type) {\n      case '0x0':\n        txSchema = transactionType0x0Schema;\n        break;\n      case '0x1':\n        txSchema = transactionType0x1Schema;\n        break;\n      case '0x2':\n        txSchema = transactionType0x2Schema;\n        break;\n      default:\n        return format({\n          format: 'uint'\n        }, tx.type, ETH_DATA_FORMAT);\n    }\n    validateTxTypeAndHandleErrors(txSchema, tx, tx.type);\n    return format({\n      format: 'uint'\n    }, tx.type, ETH_DATA_FORMAT);\n  }\n  if (!isNullish(tx.maxFeePerGas) || !isNullish(tx.maxPriorityFeePerGas)) {\n    validateTxTypeAndHandleErrors(transactionType0x2Schema, tx, '0x2');\n    return '0x2';\n  }\n  if (!isNullish(tx.accessList)) {\n    validateTxTypeAndHandleErrors(transactionType0x1Schema, tx, '0x1');\n    return '0x1';\n  }\n  const givenHardfork = (_a = tx.hardfork) !== null && _a !== void 0 ? _a : (_b = tx.common) === null || _b === void 0 ? void 0 : _b.hardfork;\n  if (!isNullish(givenHardfork)) {\n    const hardforkIndex = Object.keys(HardforksOrdered).indexOf(givenHardfork);\n    // givenHardfork is London or later, so EIP-2718 is supported\n    if (hardforkIndex >= Object.keys(HardforksOrdered).indexOf('london')) return !isNullish(tx.gasPrice) ? '0x0' : '0x2';\n    // givenHardfork is Berlin, tx.accessList is undefined, assume type is 0x0\n    if (hardforkIndex === Object.keys(HardforksOrdered).indexOf('berlin')) return '0x0';\n  }\n  // gasprice is defined\n  if (!isNullish(tx.gasPrice)) {\n    validateTxTypeAndHandleErrors(transactionType0x0Schema, tx, '0x0');\n    return '0x0';\n  }\n  // no transaction type can be inferred from properties, use default transaction type\n  return undefined;\n};\nexport const detectTransactionType = (transaction, web3Context) => {\n  var _a;\n  return ((_a = web3Context === null || web3Context === void 0 ? void 0 : web3Context.transactionTypeParser) !== null && _a !== void 0 ? _a : defaultTransactionTypeParser)(transaction);\n};\nexport const detectRawTransactionType = transaction => transaction[0] > 0x7f ? '0x0' : toHex(transaction[0]);","map":{"version":3,"names":["format","toHex","HardforksOrdered","ETH_DATA_FORMAT","Web3ValidatorError","isNullish","validator","InvalidPropertiesForTransactionTypeError","transactionType0x0Schema","type","properties","accessList","maxFeePerGas","maxPriorityFeePerGas","transactionType0x1Schema","transactionType0x2Schema","gasPrice","validateTxTypeAndHandleErrors","txSchema","tx","txType","validateJSONSchema","error","errors","defaultTransactionTypeParser","transaction","givenHardfork","_a","hardfork","_b","common","hardforkIndex","Object","keys","indexOf","undefined","detectTransactionType","web3Context","transactionTypeParser","detectRawTransactionType"],"sources":["../../../src/utils/detect_transaction_type.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}